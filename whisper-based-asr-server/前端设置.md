---
sort: 3
---

# å‰ç«¯è®¾ç½®

å‰ç«¯ç•Œé¢å‚è€ƒäº†[ns2250225/audioRecord: ğŸ“¢ ä»¿å¾®ä¿¡çš„è¯­éŸ³æ®µä¼ è¾“ (github.com)](https://github.com/ns2250225/audioRecord)ï¼Œ ä½¿ç”¨ html+css+js ç¼–å†™ç½‘é¡µï¼Œå…¶ä¸­htmlæ§åˆ¶é¡µé¢ä¸­æœ‰å“ªäº›ç»„æˆéƒ¨åˆ†ï¼Œcssæ§åˆ¶å„ç»„æˆéƒ¨åˆ†çš„å¤–è§‚ï¼ŒJSæ§åˆ¶é¡µé¢çš„æ‰§è¡Œé€»è¾‘ã€‚

å‰ç«¯ä»£ç ä¸­ï¼Œè¾ƒä¸ºé‡è¦çš„ä¸¤ä¸ªæ­¥éª¤åœ¨äºéŸ³é¢‘å½•åˆ¶å’ŒéŸ³é¢‘ä¼ è¾“ã€‚ä»¥ä¸‹åˆ†è¾¨ä»‹ç»è¿™ä¸¤ä¸ªéƒ¨åˆ†ã€‚

## 1. éŸ³é¢‘å½•åˆ¶

éŸ³é¢‘å½•åˆ¶ä»£ç å¦‚ä¸‹,ä¸»è¦åŸºäº MediaRecorder æœåŠ¡ã€‚

```javascript
if (navigator.mediaDevices.getUserMedia) {
  console.log('getUserMedia supported.');

  var constraints = { audio: true };
  var chunks = [];

  var onSuccess = function (stream) {
    var mediaRecorder = new MediaRecorder(stream);

    record.onclick = function () {
      mediaRecorder.start();
      console.log(mediaRecorder.state);
      console.log("recorder started");

      stop.disabled = false;
      record.disabled = true;
    }

    stop.onclick = function () {
      mediaRecorder.stop();
      console.log(mediaRecorder.state);
      console.log("recorder stopped");

      stop.disabled = true;
      record.disabled = false;
    }

    mediaRecorder.onstop = function (e) {
      console.log("data available after MediaRecorder.stop() called.");

      // ä¿å­˜å½•éŸ³
      var blob = new Blob(chunks, { 'type': 'audio/ogg; codecs=opus' });

      // ç”Ÿæˆå½•éŸ³æ¡†
      createAudioBox(blob, msg_content)

      // å‘é€å½•éŸ³
      ws.send(blob)

      // é‡ç½®å½•éŸ³æ•°æ®
      chunks = [];

      console.log("recorder stopped");
    }

    // å½•éŸ³é€»è¾‘
    mediaRecorder.ondataavailable = function (e) {
      chunks.push(e.data);
    }
  }

  var onError = function (err) {
    console.log('The following error occured: ' + err);
  }

  // å¼€å§‹è·å–éŸ³é¢‘æµ
  navigator.mediaDevices.getUserMedia(constraints).then(onSuccess, onError);

} else {
  console.log('getUserMedia not supported on your browser!');
}

```

ä»¥ä¸Šä»£ç ä¸­çš„å½•éŸ³æ¡†å‡½æ•°`createAudioBox()`å¦‚ä¸‹æ‰€ç¤ºã€‚æ³¨æ„è¿™é‡Œçš„ä¸€ä¸ªå‘æ˜¯ï¼Œæ­£å¸¸è®¾ç½®å½•éŸ³æ¡†æ—¶ï¼Œ`audio.duration` å±æ€§ï¼Œè¿™è¯´æ˜è®¡ç®—æœºä¸æ¸…æ¥šéŸ³é¢‘çš„å…·ä½“æ—¶é•¿ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦å°†`audio.currentTime` èµ‹ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œç›¸å½“äºç›´æ¥å°†è¿›åº¦æ¡æ‹‰åˆ°ç»ˆç‚¹ï¼Œä»¥æ£€æµ‹éŸ³é¢‘å…·ä½“çš„æ—¶é—´ã€‚

```javascript
/* åˆ›å»ºéŸ³é¢‘æ¡† */
function createAudioBox(blob_obj, msg_content) {
  var tmp_div = document.createElement('div');
  var audio = document.createElement('audio');
  var tmp_span = document.createElement('span');
  var tmp_btn = document.createElement('img');

  tmp_div.setAttribute('class', 'myAudio');
  tmp_span.setAttribute('class', 'audio_time');
  tmp_btn.setAttribute('class', 'play_btn');
  tmp_btn.src = "/static/images/audio-high.png"
  audio.setAttribute('id', 'myAudio');
  audio.src = window.URL.createObjectURL(blob_obj);
  audio.addEventListener('loadedmetadata', () => {
    if (audio.duration === Infinity || isNaN(Number(audio.duration))) {
      audio.currentTime = 1e101   // ç›¸å½“äºå¿«è¿›
      audio.addEventListener('timeupdate', getDuration)
    }
  })
function getDuration(event) {
	event.target.currentTime = 0
	event.target.removeEventListener('timeupdate', getDuration)
    tmp_span.innerHTML = event.target.duration + '"'
}
```



## 2. éŸ³é¢‘ä¼ è¾“ 

éŸ³é¢‘ä¼ è¾“æœåŠ¡ä»£ç å¦‚ä¸‹, æ ¸å¿ƒæ˜¯åˆ©ç”¨ `WebSocket()`ä¸æœåŠ¡å™¨ä¹‹é—´å»ºç«‹å¥—æ¥å­—ã€‚

```javascript
// æ³¨å†ŒPWAæœåŠ¡
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/static/js/sw.js')
    .then(function () {
      console.log('SW registered');
    });
}

// è®¾ç½®websocketæœåŠ¡å™¨åœ°å€
const wsUrl = 'ws://localhost:8000/';
const ws = new WebSocket(wsUrl);
ws.binaryType = "arraybuffer";

// Websocketé’©å­æ–¹æ³•
ws.onopen = function (evt) {
  console.log('ws open()');
}

ws.onerror = function (err) {
  console.error('ws onerror() ERR:', err);
}

ws.onmessage = function (evt) {
  console.log('ws onmessage() data:', typeof (evt.data));
  // åˆ¤æ–­ typeof (evt.data) æ˜¯å¦ä¸ºæ–‡æœ¬ç±»å‹
  if (typeof (evt.data) === 'string') {
    // æ·»åŠ æ–‡æœ¬æ˜¾ç¤ºæ¡†
    var tmp_div = document.createElement('div');
    tmp_div.setAttribute('class', 'myText');
    tmp_div.innerHTML = evt.data;
    msg_content.appendChild(tmp_div);
  } else if (typeof (evt.data) === 'object') {
    // TODO: æœªæ¥æ·»åŠ TTSæœåŠ¡æ—¶ï¼Œå¯åœ¨æ­¤å¢åŠ æ¥å—è¯­éŸ³çš„é€»è¾‘
  } else {
    console.error('Unexpected data type:', typeof (evt.data));
  }
}
```

